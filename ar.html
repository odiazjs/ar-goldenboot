<!DOCTYPE html>
<html>

<head>
  <title>
    Barcelona AR Experience
  </title>

  <meta name="description" content="balondioro">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="/css/all.min.css">
  <link rel="stylesheet" href="/css/flexboxgrid.min.css">
  <link rel="stylesheet" type="text/css" href="/css/animate.css">
  <link rel="stylesheet" href="https://unpkg.com/swiper/css/swiper.min.css">
  <link rel="stylesheet" type="text/css" href="/css/styles.css">

  <!-- AFRAME JS -->
  <script src="https://aframe.io/releases/1.0.3/aframe.min.js"></script>
  <script src="./aframe.js"></script>

  <!-- Swiper JS -->
  <script src="./js/swiper.min.js"></script>

  <script type="module" src="https://unpkg.com/@google/model-viewer@0.3.1/dist/model-viewer.js">
  </script>

  <script nomodule src="https://unpkg.com/@google/model-viewer@0.3.1/dist/model-viewer-legacy.js">
  </script>

  <script src="./js/hammer.js"></script>
  <script src="/script.js"></script>
  <script src="/js/app.js"></script>
  <script src="/js/media.js"></script>

  <script>

    function parseJwt(token) {
      var base64Url = token.split('.')[1];
      var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
      var jsonPayload = decodeURIComponent(atob(base64).split('').map(function (c) {
        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
      }).join(''));
      return JSON.parse(jsonPayload);
    };

    let swiper = {};
    let markerFound = false;
    let loader = null;
    const markersMedia = {
      'a-marker-1': { vidSrc: '#oro-intro' },
      'a-marker-2': { vidSrc: '#iniesta-gol' },
      'a-marker-3': { vidSrc: '#cruyff-goals' }
    };

    // API Unloackable Model
    let userId = '';
    let unlockables = [];

    // API props
    let apiUrl = 'https://api.codetenango.com/api/v1';
    //let apiUrl = 'http://localhost:8080/api/v1';
    let getUnlockablesUrl = `${apiUrl}/unlockables`;
    let createUserUnlockableUrl = (userId) => `${apiUrl}/user/${userId}/unlockables`;
    let getUsersUnlockablesUrl = (userId) => `${apiUrl}/users/${userId}/unlockables`;


    // Unlock item
    const unlockedImgSrcs = {
      'a-marker-1': { src: 'balon-oro-unlocked.png', unlocked: false },
      'a-marker-2': { src: 'iniesta-boot-unlocked.png', unlocked: false },
      'a-marker-3': { src: 'cruyff-unlocked.png', unlocked: false },
    }

    AFRAME.registerComponent('registerevents', {
      init: function () {
        var marker = this.el;

        // Make the element emit events when found and when lost.
        marker.setAttribute('emitevents', 'true');

        marker.addEventListener('markerFound', function () {
          var markerId = marker.id;
          markerFound = true;
          console.log('markerFound', markerId);
          const videoEl = document.getElementById("a-video");
          const random = Math.floor(Math.random() * 10000);
          videoEl.setAttribute('src', `${markersMedia[markerId].vidSrc}?${random}`);
          playMedia();

          const item = unlockedImgSrcs[markerId];

          const markerIndex = markerId.split('-')[2];
          const activeIndex = markerIndex;
          swiper.slideTo(activeIndex);

          if (item.unlocked) {
            console.log('item already unlocked - ', item);
            return;
          }

          setTimeout(() => {
            const unlockable = document.querySelector(`div[unlockable=${markerId}] img`);
            const lock = document.querySelector(`div[unlockable=${markerId}] i`);
            const imgSrc = unlockable.getAttribute("src");
            unlockable.style.marginTop = '6em';
            lock.style.display = 'none';
            console.log('marker unlock - ', unlockable);
            unlockable.setAttribute("src", `/assets/${item.src}`);
            item.unlocked = true;
          }, 1000)

        });

        marker.addEventListener('markerLost', function () {
          var markerId = marker.id;
          markerFound = false;
          console.log('markerLost', markerId);
          pauseMedia();
        });
      }
    });
    AFRAME.registerComponent('modelonload', {
      init: function () {
        loader = document.querySelector("#spinner");
        this.el.addEventListener('model-loaded', e => {
          if (markerFound) {
            playMedia();
          }
        })
      },
      tick: function () {
        if (markerFound && loader) {
          setTimeout(() => {
            loader.style.display = "none";
          });
        } else {
          setTimeout(() => {
            loader.style.display = "";
          });
        }
      }
    });

    // Media
    const playMedia = () => {
      var v = document.querySelector('#oro-intro');
      var v2 = document.querySelector('#iniesta-gol');
      v.play();
      v2.play();
    }
    const pauseMedia = () => {
      var v = document.querySelector('#oro-intro');
      var v2 = document.querySelector('#iniesta-gol');
      v.pause();
      v2.pause();
    }
    window.addEventListener('click', function () {

    });

    // Get Query Params
    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('token');
    const airplaneMode = urlParams.get('airplane_mode');
    console.log('parsed token is - ', parseJwt(token))
    console.log('airplane_mode is - ', airplaneMode)
    userId = parseJwt(token)

  </script>

</head>

<body style='margin : 0px; overflow: hidden;'>

  <div id="spinner" class="loading">
    <div class="loader"></div>
  </div>

  <!-- FC Barcelona Brand Start -->
  <div class="header">
    <div class="row" style="margin: 4px;">
      <div class="col-xs-1">
        <img class="logo" src="./assets/fcblogo.png" alt="fcb logo" />
      </div>
      <div class="col-xs-11">
        <a href="#" class="title" style="margin: 0vw 5vw">FC BARCELONA AR EXPERIENCE</a>
      </div>
    </div>
  </div>

  <footer>
    <div class="swiper-container">
      <div class="swiper-wrapper">
        <div class="swiper-slide">
          <div class="model-title">
            <h3>Bota de Oro 2018-2019</h3>
          </div>
          <div unlockable="a-marker-1">
            <i class="fas fa-lock"></i>
            <img class="lock" src="./assets/balon-oro-locked2.png" alt="fcb logo" />
          </div>
        </div>
        <div class="swiper-slide">
          <div class="model-title">
            <h3>Bota Iniesta 2009 vs Chelsea</h3>
          </div>
          <div unlockable="a-marker-2">
            <i class="fas fa-lock"></i>
            <img class="lock" src="./assets/iniesta-boot-locked.png" alt="fcb logo" />
          </div>
        </div>
        <div class="swiper-slide">
          <div class="model-title">
            <h3>Camisola de Cruyff</h3>
          </div>
          <div unlockable="a-marker-3">
            <i class="fas fa-lock"></i>
            <img class="lock" src="./assets/cruyff-locked.png" alt="fcb logo" />
          </div>
        </div>
      </div>
      <!-- Add Pagination -->
      <div class="swiper-pagination"></div>
      <!-- Add Arrows -->
      <div class="swiper-button-next"></div>
      <div class="swiper-button-prev"></div>
    </div>
  </footer>

  <!-- FC Barcelona Brand End -->

  <a-scene embedded arjs='sourceType: webcam; debugUIEnabled: false;'
    renderer="colorManagement: true; physicallyCorrectLights: true; logarithmicDepthBuffer: true; sortObjects: false;">

    <a-assets>
      <a-entity src="/assets/botin-oro/Botin de Oro.gltf?12345" id="golden-boot"></a-entity>
      <a-entity src="/assets/iniesta/Zapato Iniesta.gltf?12345" id="iniesta-boot"></a-entity>
      <a-entity src="/assets/shirt/Camisola Cryuff.gltf?12345" id="cryuff-shirt"></a-entity>
      <video id="oro-intro" autoplay loop controls="true" crossorigin="anonymous" playsinline webkit-playsinline media
        muted="true" play="true" src="./assets/videos/botin-oro-messi-low-res.mp4?12345678910">
      </video>
      <video id="iniesta-gol" autoplay loop controls="true" crossorigin="anonymous" playsinline webkit-playsinline
        media2 muted="true" play="true" src="./assets/videos/Gol de Iniesta.mp4?12345678910">
      </video>
      <video id="cruyff-goals" autoplay loop controls="true" crossorigin="anonymous" playsinline webkit-playsinline
        media2 muted="true" play="true" src="./assets/videos/cruyff-goals.mp4?12345678910">
      </video>
    </a-assets>

    <a-video id="a-video" media media2 src="#oro-intro" width="16" height="9" position="0 5 -30" rotation="0 0 0"
      scale=".5 .5 .5">
    </a-video>

    <a-marker id="a-marker-1" listener interaction hammer registerevents emitevents="true" cursor="rayOrigin: mouse"
      type='pattern' url='./assets/markers/pattern-goldenboot.patt'>
    </a-marker>

    <a-entity id="target" gltf-model="#golden-boot" position="-0.14671 -1.37996 -8.10592" modelonload rotation="20 0 0"
      scale=".1 .1 .1" visible="">
    </a-entity>

    <a-marker id="a-marker-2" listener2 interaction hammer2 registerevents emitevents="true" cursor="rayOrigin: mouse"
      type='pattern' url='./assets/markers/pattern-iniesta-marker.patt'>
    </a-marker>

    <a-entity id="target2" gltf-model="#iniesta-boot" position="-0.14671 -1.37996 -8.10592" modelonload
      rotation="20 0 0" scale=".3 .3 .3" visible="">
    </a-entity>

    <a-marker id="a-marker-3" listener3 interaction hammer3 registerevents emitevents="true" cursor="rayOrigin: mouse"
      type='pattern' url='./assets/markers/pattern-cruyff.patt'>
    </a-marker>

    <a-entity id="target3" gltf-model="#cryuff-shirt" position="-0.14671 -1.37996 -8.10592" modelonload rotation="0 0 0"
      scale="1 1 1" visible="">
    </a-entity>

    <a-camera-static />

    <a-light id="spot-light" type="spot" color="white"
      light="type: point; color: #ffffff; intensity: 50; penumbra: 1; castShadow: true; shadowBias: 1"
      position="0 2 -1" rotation="">
    </a-light>

  </a-scene>

  <script>
    //Swipper
    setTimeout(() => {
      swiper = new Swiper('.swiper-container', {
        slidesPerView: 1,
        spaceBetween: 30,
        loop: true,
        pagination: {
          el: '.swiper-pagination',
          clickable: true,
        },
        navigation: {
          nextEl: '.swiper-button-next',
          prevEl: '.swiper-button-prev',
        },
      });

      swiper.on('slideChange', function (ev) {
        const markerId = swiper.slides[swiper.activeIndex].children[1].getAttribute('unlockable');
        const lock = swiper.slides[swiper.activeIndex].children[1].children[0];
        let imgSrc = swiper.slides[swiper.activeIndex].children[1].children[1].src;
        console.log('slide changed', imgSrc);
        const item = unlockedImgSrcs[markerId];
        if (item.unlocked){
          const el = swiper.slides[swiper.activeIndex].children[1].children[1];
          lock.style.display = 'none';
          el.style.marginTop = '6em';
          el.src = `/assets/${item.src}`;
        }
      });

      // Get All Unlockables
      fetch(getUnlockablesUrl, {
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        referrer: 'no-referrer'
      })
        .then((response) => {
          response.json()
            .then(({ data }) => {
              unlockables = [...data]
            })
        })

    }, 1000)
  </script>
</body>

</html>